<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ServletServer.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">site</a> &gt; <a href="index.source.html" class="el_package">com.hexagontk.http.server.servlet</a> &gt; <span class="el_source">ServletServer.kt</span></div><h1>ServletServer.kt</h1><pre class="source lang-java linenums">package com.hexagontk.http.server.servlet

import com.hexagontk.core.text.AnsiColor.BLUE
import com.hexagontk.core.text.AnsiEffect.BOLD
import com.hexagontk.core.text.AnsiColor.CYAN
import com.hexagontk.core.text.AnsiColor.MAGENTA
import com.hexagontk.core.text.Ansi.RESET
import com.hexagontk.core.Platform
import com.hexagontk.core.Platform.cpuCount
import com.hexagontk.core.Platform.hostName
import com.hexagontk.core.Platform.localeCode
import com.hexagontk.core.Platform.name
import com.hexagontk.core.Platform.timeZone
import com.hexagontk.core.Platform.totalMemory
import com.hexagontk.core.Platform.usedMemory
import com.hexagontk.core.Platform.version
import com.hexagontk.core.text.prependIndent
import com.hexagontk.core.require
import com.hexagontk.http.server.HttpServer
import com.hexagontk.http.server.serverBanner
import com.hexagontk.http.handlers.HttpHandler
import com.hexagontk.http.handlers.OnHandler
import jakarta.servlet.*
import java.util.*

/**
 * Adapter to run a router inside a Servlets container. It is not a standard engine as it is not
 * started/stopped (not passed to an [HttpServer]).
 */
<span class="pc" id="L30">abstract class ServletServer(</span>
<span class="pc" id="L31">    private val handler: HttpHandler = OnHandler { this },</span>
<span class="nc" id="L32">) : ServletContextListener {</span>

    override fun contextInitialized(sce: ServletContextEvent) {
<span class="fc" id="L35">        val servletFilter = ServletFilter(handler)</span>
        // Let's be a good JEE citizen
<span class="fc" id="L37">        val servletContext = sce.servletContext</span>
<span class="fc" id="L38">        servletFilter.init(object : FilterConfig {</span>
<span class="pc" id="L39">            val params = Hashtable&lt;String, String&gt;(1).apply { put(&quot;filterName&quot;, filterName) }</span>
<span class="fc" id="L40">            override fun getFilterName(): String = ServletFilter::class.java.name</span>
<span class="fc" id="L41">            override fun getServletContext(): ServletContext = servletContext</span>
<span class="fc" id="L42">            override fun getInitParameter(name: String): String = params.require(name)</span>
<span class="fc" id="L43">            override fun getInitParameterNames(): Enumeration&lt;String&gt; = params.keys()</span>
        })
<span class="fc" id="L45">        val filter = servletContext.addFilter(&quot;filters&quot;, servletFilter)</span>
<span class="fc" id="L46">        filter.addMappingForUrlPatterns(EnumSet.allOf(DispatcherType::class.java), true, &quot;/*&quot;)</span>
<span class="fc" id="L47">    }</span>

<span class="fc" id="L49">    fun createBanner(</span>
<span class="pc" id="L50">        startUpTimestamp: Long = -1, banner: String = serverBanner, detailed: Boolean = false</span>
    ): String {
<span class="fc" id="L52">        val server = &quot;$BOLD$CYAN${javaClass.simpleName}$RESET&quot;</span>
<span class="fc" id="L53">        val java = &quot;$BOLD${BLUE}Java $version$RESET [$BLUE$name$RESET]&quot;</span>
<span class="fc" id="L54">        val locale = &quot;$BLUE$localeCode$RESET&quot;</span>
<span class="fc" id="L55">        val timezone = &quot;$BLUE${timeZone.id}$RESET&quot;</span>
<span class="fc" id="L56">        val charsetValue = &quot;$BLUE${Platform.charset}$RESET&quot;</span>
<span class="pc bpc" id="L57" title="1 of 2 branches missed.">        val start = if (startUpTimestamp &lt; 0) &quot;&lt;undefined&gt;&quot; else startUpTimestamp.toString()</span>
<span class="fc" id="L58">        val startTime = &quot;$BOLD$MAGENTA in $start ms$RESET&quot;</span>

<span class="pc bpc" id="L60" title="1 of 2 branches missed.">        val information = if (detailed)</span>
<span class="nc" id="L61">            detailBanner(server, java, locale, timezone, charsetValue, startTime)</span>
        else
            &quot;&quot;&quot;

<span class="fc" id="L65">            Server Adapter: $server</span>

<span class="fc" id="L67">            üõ† Using $java</span>
<span class="fc" id="L68">            üåç Locale: $locale Timezone: $timezone Charset: $charsetValue</span>

<span class="fc" id="L70">            ‚è±Ô∏è Started$startTime</span>
            üöÄ Served at a JEE Server

            &quot;&quot;&quot;

<span class="fc" id="L75">        val fullBanner = banner + information.trimIndent()</span>
<span class="fc" id="L76">        return &quot;\n&quot; + fullBanner.prependIndent()</span>
    }

    private fun detailBanner(
        server: String,
        java: String,
        locale: String,
        timezone: String,
        charsetValue: String,
        startTime: String
    ): String {
<span class="nc" id="L87">        val bootTime = &quot;%01.3f&quot;.format(Platform.uptime() / 1e3)</span>
<span class="nc" id="L88">        val uptimeValue = &quot;$BOLD$MAGENTA$bootTime s$RESET&quot;</span>
<span class="nc" id="L89">        val jvmMemoryValue = &quot;$BLUE${totalMemory()} KB$RESET&quot;</span>
<span class="nc" id="L90">        val usedMemoryValue = &quot;$BOLD$MAGENTA${usedMemory()} KB$RESET&quot;</span>
<span class="nc" id="L91">        val hostnameValue = &quot;$BLUE$hostName$RESET&quot;</span>
<span class="nc" id="L92">        val cpuCountValue = &quot;$BLUE$cpuCount$RESET&quot;</span>

<span class="nc" id="L94">        return &quot;&quot;&quot;</span>

<span class="nc" id="L96">            Server Adapter: $server</span>

<span class="nc" id="L98">            üñ•Ô∏èÔ∏è Running in '$hostnameValue' with $cpuCountValue CPUs $jvmMemoryValue of memory</span>
<span class="nc" id="L99">            üõ† Using $java</span>
<span class="nc" id="L100">            üåç Locale: $locale Timezone: $timezone Charset: $charsetValue</span>

<span class="nc" id="L102">            ‚è±Ô∏è Started$startTime (uptime: $uptimeValue) using $usedMemoryValue</span>
            üöÄ Served at a JEE Server

            &quot;&quot;&quot;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>