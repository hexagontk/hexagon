<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ServletServer.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">site</a> &gt; <a href="index.source.html" class="el_package">com.hexagontk.http.server.servlet</a> &gt; <span class="el_source">ServletServer.kt</span></div><h1>ServletServer.kt</h1><pre class="source lang-java linenums">package com.hexagontk.http.server.servlet

import com.hexagontk.core.text.AnsiColor.BLUE
import com.hexagontk.core.text.AnsiEffect.BOLD
import com.hexagontk.core.text.AnsiColor.CYAN
import com.hexagontk.core.text.AnsiColor.MAGENTA
import com.hexagontk.core.text.Ansi.RESET
import com.hexagontk.core.Platform
import com.hexagontk.core.info
import com.hexagontk.core.loggerOf
import com.hexagontk.core.text.prependIndent
import com.hexagontk.core.require
import com.hexagontk.http.server.HttpServer
import com.hexagontk.http.server.HttpServerSettings
import com.hexagontk.http.handlers.HttpHandler
import com.hexagontk.http.handlers.OnHandler
import jakarta.servlet.*
import java.lang.System.Logger
import java.lang.management.ManagementFactory
import java.util.*

/**
 * Adapter to run a router inside a Servlets container. It is not a standard engine as it is not
 * started/stopped (not passed to an [HttpServer]).
 */
<span class="fc" id="L26">abstract class ServletServer(</span>
<span class="pc" id="L27">    private val handler: HttpHandler = OnHandler { this },</span>
<span class="fc" id="L28">    private val settings: HttpServerSettings = HttpServerSettings(),</span>
<span class="fc" id="L29">) : ServletContextListener {</span>

    private companion object {
<span class="pc" id="L32">        val logger: Logger = loggerOf(ServletServer::class)</span>
    }

    override fun contextInitialized(sce: ServletContextEvent) {
<span class="fc" id="L36">        val startTimestamp = System.nanoTime()</span>

<span class="fc" id="L38">        val servletFilter = ServletFilter(handler)</span>
        // Let's be a good JEE citizen
<span class="fc" id="L40">        val servletContext = sce.servletContext</span>
<span class="fc" id="L41">        servletFilter.init(object : FilterConfig {</span>
<span class="pc" id="L42">            val params = Hashtable&lt;String, String&gt;(1).apply { put(&quot;filterName&quot;, filterName) }</span>
<span class="fc" id="L43">            override fun getFilterName(): String = ServletFilter::class.java.name</span>
<span class="fc" id="L44">            override fun getServletContext(): ServletContext = servletContext</span>
<span class="fc" id="L45">            override fun getInitParameter(name: String): String = params.require(name)</span>
<span class="fc" id="L46">            override fun getInitParameterNames(): Enumeration&lt;String&gt; = params.keys()</span>
        })
<span class="fc" id="L48">        val filter = servletContext.addFilter(&quot;filters&quot;, servletFilter)</span>
<span class="fc" id="L49">        filter.addMappingForUrlPatterns(EnumSet.allOf(DispatcherType::class.java), true, &quot;/*&quot;)</span>

<span class="fc" id="L51">        logger.info { &quot;Server started\n${createBanner(System.nanoTime() - startTimestamp)}&quot; }</span>
<span class="fc" id="L52">    }</span>

    override fun contextDestroyed(sce: ServletContextEvent?) {
<span class="fc" id="L55">        logger.info { &quot;Server context destroyed&quot; }</span>
<span class="fc" id="L56">    }</span>

    private fun createBanner(startUpTimestamp: Long): String {

<span class="fc" id="L60">        val heap = ManagementFactory.getMemoryMXBean().heapMemoryUsage</span>
<span class="fc" id="L61">        val jvmMemory = &quot;%,d&quot;.format(heap.init / 1024)</span>
<span class="fc" id="L62">        val usedMemory = &quot;%,d&quot;.format(heap.used / 1024)</span>
<span class="fc" id="L63">        val bootTime = &quot;%01.3f&quot;.format(ManagementFactory.getRuntimeMXBean().uptime / 1e3)</span>
<span class="fc" id="L64">        val startUpTime = &quot;%,.0f&quot;.format(startUpTimestamp / 1e6)</span>

<span class="fc" id="L66">        val serverAdapterValue = &quot;$BOLD$CYAN${javaClass.simpleName}$RESET&quot;</span>

<span class="fc" id="L68">        val hostnameValue = &quot;$BLUE${Platform.hostName}$RESET&quot;</span>
<span class="fc" id="L69">        val cpuCountValue = &quot;$BLUE${Platform.cpuCount}$RESET&quot;</span>
<span class="fc" id="L70">        val jvmMemoryValue = &quot;$BLUE$jvmMemory$RESET&quot;</span>

<span class="fc" id="L72">        val javaVersionValue =</span>
<span class="fc" id="L73">            &quot;$BOLD${BLUE}Java ${Platform.version}$RESET [$BLUE${Platform.name}$RESET]&quot;</span>

<span class="fc" id="L75">        val localeValue = &quot;$BLUE${Platform.localeCode}$RESET&quot;</span>
<span class="fc" id="L76">        val timezoneValue = &quot;$BLUE${Platform.timeZone.id}$RESET&quot;</span>
<span class="fc" id="L77">        val charsetValue = &quot;$BLUE${Platform.charset}$RESET&quot;</span>

<span class="fc" id="L79">        val bootTimeValue = &quot;$BOLD$MAGENTA$bootTime s$RESET&quot;</span>
<span class="fc" id="L80">        val startUpTimeValue = &quot;$BOLD$MAGENTA$startUpTime ms$RESET&quot;</span>
<span class="fc" id="L81">        val usedMemoryValue = &quot;$BOLD$MAGENTA$usedMemory KB$RESET&quot;</span>

<span class="fc" id="L83">        val information = &quot;&quot;&quot;</span>

<span class="fc" id="L85">            Server Adapter: $serverAdapterValue</span>

<span class="fc" id="L87">            üñ•Ô∏èÔ∏è Running in '$hostnameValue' with $cpuCountValue CPUs $jvmMemoryValue KB</span>
<span class="fc" id="L88">            üõ† Using $javaVersionValue</span>
<span class="fc" id="L89">            üåç Locale: $localeValue Timezone: $timezoneValue Charset: $charsetValue</span>

<span class="fc" id="L91">            ‚è± Started in $bootTimeValue (server: $startUpTimeValue) using $usedMemoryValue</span>
            üöÄ Served at a JEE Server

<span class="fc" id="L94">        &quot;&quot;&quot;.trimIndent()</span>

<span class="pc bpc" id="L96" title="2 of 4 branches missed.">        val banner = (settings.banner?.let { &quot;$it\n&quot; } ?: HttpServer.banner) + information</span>
<span class="fc" id="L97">        return banner.prependIndent()</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>