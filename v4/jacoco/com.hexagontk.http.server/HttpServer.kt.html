<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HttpServer.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">site</a> &gt; <a href="index.source.html" class="el_package">com.hexagontk.http.server</a> &gt; <span class="el_source">HttpServer.kt</span></div><h1>HttpServer.kt</h1><pre class="source lang-java linenums">package com.hexagontk.http.server

import com.hexagontk.core.Platform.charset
import com.hexagontk.core.Platform.cpuCount
import com.hexagontk.core.Platform.hostName
import com.hexagontk.core.Platform.name
import com.hexagontk.core.Platform.version
import com.hexagontk.core.Platform.localeCode

import java.lang.Runtime.getRuntime
import com.hexagontk.core.text.AnsiColor.BLUE
import com.hexagontk.core.text.AnsiColor.CYAN
import com.hexagontk.core.text.AnsiColor.MAGENTA
import com.hexagontk.core.text.Ansi.RESET
import com.hexagontk.core.text.AnsiEffect.BOLD
import com.hexagontk.core.text.AnsiEffect.UNDERLINE
import com.hexagontk.core.Platform.timeZone
import com.hexagontk.core.Platform.totalMemory
import com.hexagontk.core.Platform.usedMemory
import com.hexagontk.core.text.prependIndent
import com.hexagontk.http.HttpFeature.ZIP
import com.hexagontk.http.handlers.HttpHandler
import com.hexagontk.http.handlers.HandlerBuilder
import com.hexagontk.http.handlers.path
import java.io.Closeable
import java.net.URI

/**
 * Server that listen to HTTP connections on a port and address and route requests to handlers.
 *
 * TODO Allow light startup log
 */
<span class="fc" id="L33">class HttpServer(</span>
<span class="fc" id="L34">    private val adapter: HttpServerPort,</span>
<span class="fc" id="L35">    val handler: HttpHandler,</span>
<span class="fc" id="L36">    val settings: HttpServerSettings = HttpServerSettings()</span>
<span class="fc" id="L37">) : Closeable {</span>

    /**
     * Create a server with a builder ([HandlerBuilder]) to set up handlers.
     *
     * @param adapter The server engine.
     * @param settings Server settings. Port and address will be searched in this map.
     * @param block Handlers' setup block.
     * @return A new server with the configured handlers.
     */
<span class="nc" id="L47">    constructor(</span>
        adapter: HttpServerPort,
<span class="nc" id="L49">        settings: HttpServerSettings = HttpServerSettings(),</span>
        block: HandlerBuilder.() -&gt; Unit
    ) :
<span class="pc" id="L52">        this(adapter, path(block = block), settings)</span>

    override fun close() {
<span class="fc" id="L55">        stop()</span>
<span class="fc" id="L56">    }</span>

<span class="fc" id="L58">    init {</span>
<span class="fc" id="L59">        val supportedProtocols = adapter.supportedProtocols()</span>
<span class="fc bfc" id="L60" title="All 2 branches covered.">        check(settings.protocol in supportedProtocols) {</span>
<span class="fc" id="L61">            val supportedProtocolsText = supportedProtocols.joinToString(&quot;, &quot;)</span>
<span class="fc" id="L62">            &quot;Requesting unsupported protocol. Adapter's protocols: $supportedProtocolsText&quot;</span>
        }

<span class="fc bfc" id="L65" title="All 2 branches covered.">        if (settings.zip)</span>
<span class="fc bfc" id="L66" title="All 2 branches covered.">            check(adapter.supportedFeatures().contains(ZIP)) {</span>
<span class="fc" id="L67">                val adapterName = adapter::class.qualifiedName</span>
<span class="fc" id="L68">                &quot;Requesting ZIP compression with an adapter without support: '$adapterName'&quot;</span>
            }
<span class="fc" id="L70">    }</span>

    /**
     * Runtime port of the server.
     *
     * @exception IllegalStateException Throw an exception if the server hasn't been started.
     */
    val runtimePort: Int
<span class="fc bfc" id="L78" title="All 2 branches covered.">        get() = if (started()) adapter.runtimePort() else error(&quot;Server is not running&quot;)</span>

    /**
     * Runtime binding of the server.
     *
     * @exception IllegalStateException Throw an exception if the server hasn't been started.
     */
    val binding: URI
<span class="fc" id="L86">        get() = URI(&quot;${settings.bindUrl}:$runtimePort&quot;)</span>

    /**
     * The port name of the server.
     */
<span class="fc" id="L91">    val portName: String = adapter.javaClass.simpleName</span>

    /**
     * Check whether the server has been started.
     *
     * @return True if the server has started, else false.
     */
    fun started(): Boolean =
<span class="fc" id="L99">        adapter.started()</span>

    /**
     * Start the server with the adapter instance and adds a shutdown hook for stopping the server.
     */
    fun start() {
<span class="fc" id="L105">        getRuntime().addShutdownHook(</span>
<span class="fc" id="L106">            Thread(</span>
                {
<span class="fc bfc" id="L108" title="All 2 branches covered.">                    if (started())</span>
<span class="fc" id="L109">                        adapter.shutDown()</span>
<span class="fc" id="L110">                },</span>
<span class="fc" id="L111">                &quot;shutdown-${settings.bindAddress.hostName}-${settings.bindPort}&quot;</span>
            )
        )

<span class="fc" id="L115">        adapter.startUp(this)</span>
<span class="fc" id="L116">    }</span>

    /**
     * Stop the server.
     */
    fun stop() {
<span class="fc" id="L122">        adapter.shutDown()</span>
<span class="fc" id="L123">    }</span>

<span class="fc" id="L125">    fun createBanner(</span>
<span class="pc" id="L126">        startUpTimestamp: Long = -1, banner: String = serverBanner, detailed: Boolean = false</span>
    ): String {
<span class="fc" id="L128">        val server = &quot;$BOLD$CYAN$portName$RESET&quot;</span>
<span class="fc" id="L129">        val protocol = settings.protocol</span>
<span class="fc" id="L130">        val protocols = adapter.supportedProtocols()</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">            .joinToString(&quot;$RESET, $CYAN&quot;, CYAN, RESET) { if (it == protocol) &quot;‚úÖ$it&quot; else &quot;$it&quot; }</span>

<span class="fc" id="L133">        val java = &quot;$BOLD${BLUE}Java $version$RESET [$BLUE$name$RESET]&quot;</span>
<span class="fc" id="L134">        val locale = &quot;$BLUE$localeCode$RESET&quot;</span>
<span class="fc" id="L135">        val timezone = &quot;$BLUE${timeZone.id}$RESET&quot;</span>
<span class="fc" id="L136">        val charsetValue = &quot;$BLUE$charset$RESET&quot;</span>
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">        val start = if (startUpTimestamp &lt; 0) &quot;&lt;undefined&gt;&quot; else startUpTimestamp.toString()</span>
<span class="fc" id="L138">        val startTime = &quot;$BOLD$MAGENTA in $start ms$RESET&quot;</span>
<span class="fc" id="L139">        val bindingValue = &quot;$BLUE$UNDERLINE$binding$RESET&quot;</span>

<span class="fc bfc" id="L141" title="All 2 branches covered.">        val information = if (detailed)</span>
<span class="fc" id="L142">            detailBanner(</span>
<span class="fc" id="L143">                server, protocols, java, locale, timezone, charsetValue, startTime, bindingValue</span>
            )
        else
            &quot;&quot;&quot;

<span class="fc" id="L148">            Server Adapter: $server ($protocols)</span>

<span class="fc" id="L150">            üõ† Using $java</span>
<span class="fc" id="L151">            üåç Locale: $locale Timezone: $timezone Charset: $charset</span>

<span class="fc" id="L153">            ‚è±Ô∏è Started$startTime</span>
<span class="fc" id="L154">            üöÄ Served at $bindingValue</span>

            &quot;&quot;&quot;

<span class="fc" id="L158">        val fullBanner = banner + information.trimIndent()</span>
<span class="fc" id="L159">        return &quot;\n&quot; + fullBanner.prependIndent()</span>
    }

    private fun detailBanner(
        server: String,
        protocols: String,
        java: String,
        locale: String,
        timezone: String,
        charsetValue: String,
        startTime: String,
        bindingValue: String
    ): String {
<span class="fc" id="L172">        val features = adapter.supportedFeatures()</span>
<span class="fc" id="L173">            .joinToString(&quot;$RESET, $CYAN&quot;, CYAN, RESET) { it.toString() }</span>

<span class="fc" id="L175">        val options = adapter.options()</span>
<span class="fc" id="L176">            .map { (k, v) -&gt; &quot;$k($v)&quot; }</span>
<span class="fc" id="L177">            .joinToString(&quot;$RESET, $CYAN&quot;, CYAN, RESET)</span>

<span class="fc" id="L179">        val jvmMemoryValue = &quot;$BLUE${totalMemory()} KB$RESET&quot;</span>
<span class="fc" id="L180">        val usedMemoryValue = &quot;$BOLD$MAGENTA${usedMemory()} KB$RESET&quot;</span>
<span class="fc" id="L181">        val hostnameValue = &quot;$BLUE$hostName$RESET&quot;</span>
<span class="fc" id="L182">        val cpuCountValue = &quot;$BLUE$cpuCount$RESET&quot;</span>

<span class="fc" id="L184">        return &quot;&quot;&quot;</span>

<span class="fc" id="L186">            Server Adapter: $server ($protocols)</span>
<span class="fc" id="L187">            Supported Features: $features</span>
<span class="fc" id="L188">            Configuration Options: $options</span>

<span class="fc" id="L190">            üñ•Ô∏èÔ∏è Running in '$hostnameValue' with $cpuCountValue CPUs $jvmMemoryValue of memory</span>
<span class="fc" id="L191">            üõ† Using $java</span>
<span class="fc" id="L192">            üåç Locale: $locale Timezone: $timezone Charset: $charsetValue</span>

<span class="fc" id="L194">            ‚è±Ô∏è Started$startTime using $usedMemoryValue</span>
<span class="fc" id="L195">            üöÄ Served at $bindingValue</span>

            &quot;&quot;&quot;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>