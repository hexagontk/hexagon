<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HttpServer.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">site</a> &gt; <a href="index.source.html" class="el_package">com.hexagontk.http.server</a> &gt; <span class="el_source">HttpServer.kt</span></div><h1>HttpServer.kt</h1><pre class="source lang-java linenums">package com.hexagontk.http.server

import com.hexagontk.core.Platform.charset
import com.hexagontk.core.Platform.cpuCount
import com.hexagontk.core.Platform.hostName
import com.hexagontk.core.Platform.name
import com.hexagontk.core.Platform.version
import com.hexagontk.core.Platform.localeCode
import com.hexagontk.http.model.HttpProtocol.HTTP2

import java.lang.Runtime.getRuntime
import com.hexagontk.core.text.AnsiColor.BLUE
import com.hexagontk.core.text.AnsiColor.CYAN
import com.hexagontk.core.text.AnsiColor.DEFAULT
import com.hexagontk.core.text.AnsiColor.MAGENTA
import com.hexagontk.core.text.Ansi.RESET
import com.hexagontk.core.text.AnsiEffect.BOLD
import com.hexagontk.core.text.AnsiEffect.UNDERLINE
import com.hexagontk.core.Platform.timeZone
import com.hexagontk.core.Platform.totalMemory
import com.hexagontk.core.Platform.usedMemory
import com.hexagontk.core.info
import com.hexagontk.core.loggerOf
import com.hexagontk.core.text.prependIndent
import com.hexagontk.core.urlOf
import com.hexagontk.http.HttpFeature.ZIP
import com.hexagontk.http.handlers.HttpHandler
import com.hexagontk.http.handlers.HandlerBuilder
import com.hexagontk.http.handlers.path
import java.io.Closeable
import java.lang.System.Logger
import java.lang.System.nanoTime
import java.net.URL

/**
 * Server that listen to HTTP connections on a port and address and route requests to handlers.
 *
 * TODO Allow light startup log
 */
<span class="fc" id="L40">class HttpServer(</span>
<span class="fc" id="L41">    private val adapter: HttpServerPort,</span>
<span class="fc" id="L42">    val handler: HttpHandler,</span>
<span class="fc" id="L43">    val settings: HttpServerSettings = HttpServerSettings()</span>
<span class="fc" id="L44">) : Closeable {</span>

    companion object {
<span class="fc" id="L47">        private val logger: Logger = loggerOf(this::class)</span>

<span class="fc" id="L49">        val banner: String = &quot;&quot;&quot;</span>
        $CYAN          _________
        $CYAN         /         \
        $CYAN        /   ____   /
        $CYAN       /   /   /  /
        $CYAN      /   /   /__/$BLUE   /\$BOLD    H E X A G O N$RESET
        $CYAN     /   /$BLUE          /  \$DEFAULT        ___
        $CYAN     \  /$BLUE   ___    /   /
        $CYAN      \/$BLUE   /  /   /   /$CYAN    T O O L K I T$RESET
        $BLUE          /  /___/   /
        $BLUE         /          /
        $BLUE         \_________/       https://hexagontk.com/http_server
        $RESET
<span class="fc" id="L62">        &quot;&quot;&quot;.trimIndent()</span>
    }

    /**
     * Create a server with a builder ([HandlerBuilder]) to set up handlers.
     *
     * @param adapter The server engine.
     * @param settings Server settings. Port and address will be searched in this map.
     * @param block Handlers' setup block.
     * @return A new server with the configured handlers.
     */
<span class="fc" id="L73">    constructor(</span>
        adapter: HttpServerPort,
<span class="fc" id="L75">        settings: HttpServerSettings = HttpServerSettings(),</span>
        block: HandlerBuilder.() -&gt; Unit
    ) :
<span class="fc" id="L78">        this(adapter, path(block = block), settings)</span>

    override fun close() {
<span class="fc" id="L81">        stop()</span>
<span class="fc" id="L82">    }</span>

<span class="fc" id="L84">    init {</span>
<span class="fc" id="L85">        val supportedProtocols = adapter.supportedProtocols()</span>
<span class="fc bfc" id="L86" title="All 2 branches covered.">        check(settings.protocol in supportedProtocols) {</span>
<span class="fc" id="L87">            val supportedProtocolsText = supportedProtocols.joinToString(&quot;, &quot;)</span>
<span class="fc" id="L88">            &quot;Requesting unsupported protocol. Adapter's protocols: $supportedProtocolsText&quot;</span>
        }

<span class="fc bfc" id="L91" title="All 2 branches covered.">        if (settings.zip)</span>
<span class="fc bfc" id="L92" title="All 2 branches covered.">            check(adapter.supportedFeatures().contains(ZIP)) {</span>
<span class="fc" id="L93">                val adapterName = adapter::class.qualifiedName</span>
<span class="fc" id="L94">                &quot;Requesting ZIP compression with an adapter without support: '$adapterName'&quot;</span>
            }
<span class="fc" id="L96">    }</span>

    /**
     * Runtime port of the server.
     *
     * @exception IllegalStateException Throw an exception if the server hasn't been started.
     */
    val runtimePort: Int
<span class="fc bfc" id="L104" title="All 2 branches covered.">        get() = if (started()) adapter.runtimePort() else error(&quot;Server is not running&quot;)</span>

    /**
     * Runtime binding of the server.
     *
     * @exception IllegalStateException Throw an exception if the server hasn't been started.
     */
    val binding: URL
<span class="fc" id="L112">        get() = urlOf(&quot;${settings.bindUrl}:$runtimePort&quot;)</span>

    /**
     * The port name of the server.
     */
<span class="fc" id="L117">    val portName: String = adapter.javaClass.simpleName</span>

    /**
     * Check whether the server has been started.
     *
     * @return True if the server has started, else false.
     */
    fun started(): Boolean =
<span class="fc" id="L125">        adapter.started()</span>

    /**
     * Start the server with the adapter instance and adds a shutdown hook for stopping the server.
     */
    fun start() {
<span class="fc" id="L131">        val startTimestamp = nanoTime()</span>

<span class="fc" id="L133">        getRuntime().addShutdownHook(</span>
<span class="fc" id="L134">            Thread(</span>
                {
<span class="fc bfc" id="L136" title="All 2 branches covered.">                    if (started())</span>
<span class="fc" id="L137">                        adapter.shutDown()</span>
<span class="fc" id="L138">                },</span>
<span class="fc" id="L139">                &quot;shutdown-${settings.bindAddress.hostName}-${settings.bindPort}&quot;</span>
            )
        )

<span class="fc" id="L143">        adapter.startUp(this)</span>
<span class="fc" id="L144">        logger.info { &quot;Server started${createBanner(nanoTime() - startTimestamp)}&quot; }</span>
<span class="fc" id="L145">    }</span>

    /**
     * Stop the server.
     */
    fun stop() {
<span class="fc" id="L151">        adapter.shutDown()</span>
<span class="fc" id="L152">        logger.info { &quot;Server stopped&quot; }</span>
<span class="fc" id="L153">    }</span>

    internal fun createBanner(startUpTimestamp: Long): String {

<span class="fc" id="L157">        val startUpTime = &quot;%,.0f&quot;.format(startUpTimestamp / 1e6)</span>
<span class="fc" id="L158">        val protocol = settings.protocol</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">        val banner = settings.banner ?: return &quot; at $binding ($startUpTime ms)&quot;</span>

<span class="fc" id="L161">        val jvmMemoryValue = &quot;$BLUE${totalMemory()} KB$RESET&quot;</span>
<span class="fc" id="L162">        val usedMemoryValue = &quot;$BOLD$MAGENTA${usedMemory()} KB$RESET&quot;</span>
<span class="fc" id="L163">        val serverAdapterValue = &quot;$BOLD$CYAN$portName$RESET&quot;</span>

<span class="fc" id="L165">        val protocols = adapter.supportedProtocols()</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">            .joinToString(&quot;$RESET, $CYAN&quot;, CYAN, RESET) { if (it == protocol) &quot;✅$it&quot; else &quot;$it&quot; }</span>

<span class="fc" id="L168">        val features = adapter.supportedFeatures()</span>
<span class="fc" id="L169">            .joinToString(&quot;$RESET, $CYAN&quot;, CYAN, RESET) { it.toString() }</span>

<span class="fc" id="L171">        val options = adapter.options()</span>
<span class="fc" id="L172">            .map { (k, v) -&gt; &quot;$k($v)&quot; }</span>
<span class="fc" id="L173">            .joinToString(&quot;$RESET, $CYAN&quot;, CYAN, RESET)</span>

<span class="fc" id="L175">        val hostnameValue = &quot;$BLUE$hostName$RESET&quot;</span>
<span class="fc" id="L176">        val cpuCountValue = &quot;$BLUE$cpuCount$RESET&quot;</span>

<span class="fc" id="L178">        val javaVersionValue = &quot;$BOLD${BLUE}Java $version$RESET [$BLUE$name$RESET]&quot;</span>

<span class="fc" id="L180">        val localeValue = &quot;$BLUE$localeCode$RESET&quot;</span>
<span class="fc" id="L181">        val timezoneValue = &quot;$BLUE${timeZone.id}$RESET&quot;</span>
<span class="fc" id="L182">        val charsetValue = &quot;$BLUE$charset$RESET&quot;</span>

<span class="fc" id="L184">        val startUpTimeValue = &quot;$BOLD$MAGENTA$startUpTime ms$RESET&quot;</span>
<span class="fc" id="L185">        val bindingValue = &quot;$BLUE$UNDERLINE$binding$RESET&quot;</span>

<span class="fc" id="L187">        val information =</span>
            &quot;&quot;&quot;

<span class="fc" id="L190">            Server Adapter: $serverAdapterValue ($protocols)</span>
<span class="fc" id="L191">            Supported Features: $features</span>
<span class="fc" id="L192">            Configuration Options: $options</span>

<span class="fc" id="L194">            🖥️️ Running in '$hostnameValue' with $cpuCountValue CPUs $jvmMemoryValue of memory</span>
<span class="fc" id="L195">            🛠 Using $javaVersionValue</span>
<span class="fc" id="L196">            🌍 Locale: $localeValue Timezone: $timezoneValue Charset: $charsetValue</span>

<span class="fc" id="L198">            ⏱️ Started in $startUpTimeValue (excluding VM) using $usedMemoryValue</span>
<span class="fc bfc" id="L199" title="All 2 branches covered.">            🚀 Served at $bindingValue${if (protocol == HTTP2) &quot; (HTTP/2)&quot; else &quot;&quot; }</span>

            &quot;&quot;&quot;

<span class="fc" id="L203">        val fullBanner = banner + information.trimIndent()</span>
<span class="fc" id="L204">        return &quot;\n&quot; + fullBanner.prependIndent()</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>