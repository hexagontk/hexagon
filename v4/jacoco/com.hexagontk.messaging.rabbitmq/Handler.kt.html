<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Handler.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">site</a> &gt; <a href="index.source.html" class="el_package">com.hexagontk.messaging.rabbitmq</a> &gt; <span class="el_source">Handler.kt</span></div><h1>Handler.kt</h1><pre class="source lang-java linenums">package com.hexagontk.messaging.rabbitmq

import com.hexagontk.core.loggerOf
import com.hexagontk.helpers.retry
import com.hexagontk.core.media.MediaType
import com.hexagontk.serialization.SerializationFormat
import com.hexagontk.serialization.SerializationManager.formatOfOrNull
import com.hexagontk.serialization.serialize
import com.rabbitmq.client.AMQP.BasicProperties
import com.rabbitmq.client.Channel
import com.rabbitmq.client.ConnectionFactory
import com.rabbitmq.client.DefaultConsumer
import com.rabbitmq.client.Envelope
import com.rabbitmq.client.ShutdownSignalException
import java.lang.System.Logger
import java.nio.charset.Charset
import java.nio.charset.Charset.defaultCharset
import java.util.concurrent.ExecutorService
import kotlin.reflect.KClass
import com.hexagontk.core.trace
import com.hexagontk.core.warn
import com.hexagontk.core.error
import com.hexagontk.core.debug
import com.hexagontk.serialization.parseMap

/**
 * Message handler that can reply messages to a reply queue.
 *
 * TODO Test content type support.
 */
<span class="fc" id="L31">internal class Handler&lt;T : Any, R : Any&gt; internal constructor (</span>
    connectionFactory: ConnectionFactory,
    channel: Channel,
<span class="fc" id="L34">    private val executor: ExecutorService,</span>
<span class="fc" id="L35">    private val type: KClass&lt;T&gt;,</span>
<span class="fc" id="L36">    private val handler: (T) -&gt; R,</span>
<span class="fc" id="L37">    private val serializationFormat: SerializationFormat,</span>
<span class="pc" id="L38">    val decoder: (Map&lt;String, *&gt;) -&gt; T</span>
<span class="fc" id="L39">) : DefaultConsumer(channel) {</span>

    private companion object {

        private const val RETRIES = 5
        private const val DELAY = 50L
    }

<span class="fc" id="L47">    private val log: Logger = loggerOf(this::class)</span>

<span class="fc" id="L49">    private val client: RabbitMqClient by lazy {</span>
<span class="fc" id="L50">        RabbitMqClient(connectionFactory, serializationFormat = serializationFormat)</span>
    }

    /** @see DefaultConsumer.handleDelivery */
    override fun handleDelivery(
        consumerTag: String, envelope: Envelope, properties: BasicProperties, body: ByteArray) {

<span class="fc" id="L57">        executor.execute {</span>
<span class="fc bfc" id="L58" title="All 2 branches covered.">            val charset = properties.contentEncoding ?: defaultCharset().name()</span>
<span class="fc" id="L59">            val correlationId = properties.correlationId</span>
<span class="fc" id="L60">            val replyTo = properties.replyTo</span>
<span class="pc bnc" id="L61" title="All 2 branches missed.">            val contentType = properties.contentType</span>
<span class="pc bpc" id="L62" title="1 of 2 branches missed.">                ?.let { MediaType(it) }</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">                ?.let { formatOfOrNull(it) }</span>
<span class="fc" id="L64">                ?: serializationFormat</span>

<span class="fc" id="L66">            try {</span>
<span class="pc" id="L67">                log.trace { &quot;Received message ($correlationId) in $charset&quot; }</span>
<span class="fc" id="L68">                val request = String(body, Charset.forName(charset))</span>
<span class="pc" id="L69">                log.trace { &quot;Message body:\n$request&quot; }</span>
<span class="fc" id="L70">                val input = decoder(request.parseMap(contentType))</span>

<span class="fc" id="L72">                val response = handler(input)</span>

<span class="pc bpc" id="L74" title="1 of 2 branches missed.">                if (replyTo != null)</span>
<span class="nc" id="L75">                    handleResponse(response, replyTo, correlationId)</span>
            }
<span class="fc" id="L77">            catch (ex: Exception) {</span>
<span class="fc" id="L78">                log.warn(ex) { &quot;Error processing message ($correlationId) in $charset&quot; }</span>

<span class="fc bfc" id="L80" title="All 2 branches covered.">                if (replyTo != null)</span>
<span class="fc" id="L81">                    handleError(ex, replyTo, correlationId)</span>
            }
            finally {
<span class="fc" id="L84">                retry(RETRIES, DELAY) {</span>
<span class="fc" id="L85">                    channel.basicAck(envelope.deliveryTag, false)</span>
<span class="fc" id="L86">                }</span>
            }
<span class="fc" id="L88">        }</span>
<span class="fc" id="L89">    }</span>

    /** @see DefaultConsumer.handleCancel */
    override fun handleCancel(consumerTag: String?) {
<span class="fc" id="L93">        log.error { &quot;Unexpected cancel for the consumer $consumerTag&quot; }</span>
<span class="fc" id="L94">    }</span>

    /** @see DefaultConsumer.handleCancelOk */
    override fun handleCancelOk(consumerTag: String) {
<span class="nc" id="L98">        log.debug { &quot;Explicit cancel for the consumer $consumerTag&quot; }</span>
<span class="nc" id="L99">    }</span>

    /** @see DefaultConsumer.handleShutdownSignal */
    override fun handleShutdownSignal(consumerTag: String, sig: ShutdownSignalException) {
<span class="nc bnc" id="L103" title="All 2 branches missed.">        if (sig.isInitiatedByApplication) {</span>
<span class="nc" id="L104">            log.debug { &quot;Consumer $consumerTag: shutdown is initiated by application. Ignoring it&quot; }</span>
        }
        else {
<span class="nc bnc" id="L107" title="All 2 branches missed.">            val msg = sig.localizedMessage ?: &quot;&quot;</span>
<span class="nc" id="L108">            log.debug { &quot;Consumer $consumerTag shutdown error $msg&quot; }</span>
        }
<span class="nc" id="L110">    }</span>

    /** @see DefaultConsumer.handleConsumeOk */
    override fun handleConsumeOk(consumerTag: String) {
<span class="pc" id="L114">        log.debug { &quot;Consumer $consumerTag has been registered&quot; }</span>
<span class="fc" id="L115">    }</span>

    private fun handleResponse(response: R, replyTo: String, correlationId: String?) {
<span class="nc" id="L118">        val output = when (response) {</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">            is String -&gt; response</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">            is Int -&gt; response.toString()</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">            is Long -&gt; response.toString()</span>
<span class="nc" id="L122">            else -&gt; response.serialize(serializationFormat)</span>
        }

<span class="nc" id="L125">        client.publish(replyTo, output, correlationId)</span>
<span class="nc" id="L126">    }</span>

    private fun handleError(exception: Exception, replyTo: String, correlationId: String?) {
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">        val message = exception.message ?: &quot;&quot;</span>
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">        val errorMessage = message.ifBlank { exception.javaClass.name }</span>
<span class="fc" id="L131">        client.publish(replyTo, errorMessage, correlationId)</span>
<span class="fc" id="L132">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>