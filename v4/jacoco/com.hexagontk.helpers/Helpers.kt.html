<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Helpers.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">site</a> &gt; <a href="index.source.html" class="el_package">com.hexagontk.helpers</a> &gt; <span class="el_source">Helpers.kt</span></div><h1>Helpers.kt</h1><pre class="source lang-java linenums">package com.hexagontk.helpers

import com.hexagontk.core.CodedException
import com.hexagontk.core.MultipleException
import java.io.BufferedReader
import java.io.File
import java.io.InputStreamReader
import java.lang.System.getenv
import java.net.*
import java.util.*
import java.util.concurrent.TimeUnit.SECONDS

/**
 * Load a '*.properties' file from a URL transforming the content into a plain map. If the resource
 * can not be found, a [com.hexagontk.core.ResourceNotFoundException] is thrown.
 *
 * @param url URL pointing to the file to load.
 * @return Map containing the properties file data.
 */
fun properties(url: URL): Map&lt;String, String&gt; =
<span class="fc" id="L21">    Properties()</span>
<span class="pc" id="L22">        .apply { url.openStream().use { load(it.reader()) } }</span>
<span class="fc" id="L23">        .toMap()</span>
<span class="fc" id="L24">        .mapKeys { it.key as String }</span>
<span class="fc" id="L25">        .mapValues { it.value as String }</span>

/**
 * Execute a lambda until no exception is thrown or a number of times is reached.
 *
 * @param times Number of times to try to execute the callback. Must be greater than 0.
 * @param delay Milliseconds to wait to next execution if there was an error. Must be 0 or greater.
 * @param block Code to be executed.
 * @return Callback's result if succeeded.
 * @throws [MultipleException] if the callback didn't succeed in the given times.
 */
fun &lt;T&gt; retry(times: Int, delay: Long, block: () -&gt; T): T {
<span class="fc bfc" id="L37" title="All 4 branches covered.">    require(times &gt; 0)</span>
<span class="fc bfc" id="L38" title="All 4 branches covered.">    require(delay &gt;= 0)</span>

<span class="fc" id="L40">    val exceptions = mutableListOf&lt;Exception&gt;()</span>
<span class="fc" id="L41">    (1..times).forEach {</span>
<span class="fc" id="L42">        try {</span>
<span class="fc" id="L43">            return block()</span>
        }
<span class="fc" id="L45">        catch (e: Exception) {</span>
<span class="fc" id="L46">            exceptions.add(e)</span>
<span class="fc" id="L47">            Thread.sleep(delay)</span>
        }
<span class="fc" id="L49">    }</span>

<span class="fc" id="L51">    throw MultipleException(&quot;Error retrying $times times ($delay ms)&quot;, exceptions)</span>
}

/**
 * .
 *
 * TODO Assure JVM closes properly after process execution (dispose process resources, etc.)
 */
<span class="fc" id="L59">fun List&lt;String&gt;.exec(</span>
<span class="fc" id="L60">    workingDirectory: File = File(System.getProperty(&quot;user.dir&quot;)),</span>
<span class="fc" id="L61">    timeout: Long = Long.MAX_VALUE,</span>
<span class="fc" id="L62">    fail: Boolean = true,</span>
): String {

<span class="fc bfc" id="L65" title="All 2 branches covered.">    val command = filter { it.isNotBlank() }.toTypedArray()</span>

<span class="fc bfc" id="L67" title="All 6 branches covered.">    require(command.isNotEmpty()) { &quot;Command is empty&quot; }</span>
<span class="fc bfc" id="L68" title="All 4 branches covered.">    require(timeout &gt; 0) { &quot;Process timeout should be greater than zero: $timeout&quot; }</span>

<span class="fc" id="L70">    val process = ProcessBuilder(*command).directory(workingDirectory).start()</span>

<span class="fc bfc" id="L72" title="All 2 branches covered.">    if (!process.waitFor(timeout, SECONDS)) {</span>
<span class="fc" id="L73">        process.destroy()</span>
<span class="fc" id="L74">        error(&quot;Command timed out: $this&quot;)</span>
    }

<span class="fc" id="L77">    val exitValue = process.exitValue()</span>
<span class="fc" id="L78">    val output = BufferedReader(InputStreamReader(process.inputStream)).readText()</span>

<span class="fc bfc" id="L80" title="All 4 branches covered.">    if (fail &amp;&amp; exitValue != 0)</span>
<span class="fc" id="L81">        throw CodedException(exitValue, output)</span>

<span class="fc" id="L83">    return output</span>
}

/**
 * TODO Add use case and example in documentation.
 *
 * Run the receiver's text as a process in the host operating system. The command can have multiple
 * lines and may or may not contain the shell continuation string (` \\n`).
 *
 * Multiple words parameters can not be used, for that requirement you can use the [shell] method,
 * or run exec using a list of items (program and parameters).
 *
 * @receiver String holding the command to be executed.
 * @param workingDirectory Directory on which the process will be executed. Defaults to current
 *  directory.
 * @param timeout Maximum number of seconds allowed for process execution. Defaults to the maximum
 *  long value. It must be greater than zero.
 * @param fail If true Raise an exception if the result code is different from zero. The default
 *  value is `false`.
 * @throws CodedException Thrown if the process return an error code (the actual code is passed
 *  inside [CodedException.code] and the command output is set at [CodedException.message]).
 * @throws IllegalStateException If the command doesn't end within the allowed time or the command
 *  string is blank, an exception will be thrown.
 * @return The output of the command.
 */
<span class="fc" id="L108">fun String.exec(</span>
<span class="fc" id="L109">    workingDirectory: File = File(System.getProperty(&quot;user.dir&quot;)),</span>
<span class="fc" id="L110">    timeout: Long = Long.MAX_VALUE,</span>
<span class="fc" id="L111">    fail: Boolean = false,</span>
): String =
<span class="fc" id="L113">    replace(&quot;&quot;&quot;(\s+\\\s*)?\n&quot;&quot;&quot;.toRegex(), &quot;&quot;)</span>
<span class="fc" id="L114">        .split(&quot; &quot;)</span>
<span class="fc" id="L115">        .map { it.trim() }</span>
<span class="fc" id="L116">        .toList()</span>
<span class="fc" id="L117">        .exec(workingDirectory, timeout, fail)</span>

/**
 * Executes a command in a shell (allowing to use pipes, redirections, etc.).
 *
 * TODO
 *
 * @param workingDirectory
 * @param timeout
 * @param fail
 * @return
 */
<span class="fc" id="L129">fun String.shell(</span>
<span class="fc" id="L130">    workingDirectory: File = File(System.getProperty(&quot;user.dir&quot;)),</span>
<span class="fc" id="L131">    timeout: Long = Long.MAX_VALUE,</span>
<span class="fc" id="L132">    fail: Boolean = false,</span>
): String =
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">    listOf(getenv(&quot;SHELL&quot;) ?: &quot;bash&quot;, &quot;-c&quot;, replace(&quot;&quot;&quot;(\s+\\\s*)?\n&quot;&quot;&quot;.toRegex(), &quot;&quot;))</span>
<span class="fc" id="L135">        .exec(workingDirectory, timeout, fail)</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>